<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>GitHub Workflow with OAuth Proxy</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 650px;
      margin: 0 auto;
      padding: 20px;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .workflow-section {
      background-color: #f5f5f5;
      border-radius: 8px;
      padding: 20px;
      margin-top: 20px;
    }
    
    .workflow-button {
      background-color: #2196F3;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      display: block;
      width: 200px;
      margin: 20px 0;
      transition: background-color 0.3s;
      font-size: 16px;
      font-weight: bold;
    }
    
    .auth-button {
      background-color: #28a745;
    }
    
    .workflow-button.running {
      background-color: #FFC107;
      cursor: wait;
      position: relative;
    }
    
    .workflow-button:hover:not(.running):not(:disabled) {
      opacity: 0.8;
    }
    
    .workflow-button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    
    .auth-status, .workflow-status {
      background-color: white;
      border-radius: 4px;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ddd;
    }
    
    .status-success {
      background-color: #E8F5E8;
      border-left: 4px solid #4CAF50;
      padding-left: 10px;
    }
    
    .status-error {
      background-color: #FFEBEE;
      border-left: 4px solid #F44336;
      padding-left: 10px;
    }
    
    .status-warning {
      background-color: #FFF8E1;
      border-left: 4px solid #FF9800;
      padding-left: 10px;
    }
    
    .status-running {
      background-color: #E3F2FD;
      border-left: 4px solid #2196F3;
      padding-left: 10px;
    }
    
    .status-queued {
      background-color: #FFF3E0;
      border-left: 4px solid #FF5722;
      padding-left: 10px;
    }
    
    .status-failed {
      background-color: #FFEBEE;
      border-left: 4px solid #F44336;
      padding-left: 10px;
    }
    
    .workflow-logs {
      font-family: monospace;
      background-color: #263238;
      color: #ECEFF1;
      padding: 15px;
      border-radius: 4px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      display: none;
    }
    
    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 1s ease-in-out infinite;
      margin-left: 8px;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .setup-section {
      background-color: #E1F5FE;
      border-left: 4px solid #03A9F4;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 4px;
    }
    
    .setup-section h3 {
      margin-top: 0;
      color: #0277BD;
    }
    
    .config-note {
      background-color: #FFF3E0;
      border: 1px solid #FF9800;
      border-radius: 4px;
      padding: 15px;
      margin: 20px 0;
    }
    
    .config-note h3 {
      margin-top: 0;
      color: #F57C00;
    }
  </style>
</head>

<body>
  <h1>GitHub Workflow OAuth Trigger</h1>
  
  <div class="config-note">
    <h3>⚠️ Configuration Required</h3>
    <p><strong>Before using this page, you need to:</strong></p>
    <p><strong>Step 1:</strong> Update the <code>PROXY_BASE_URL</code> in the JavaScript section below to point to your deployed OAuth proxy server</p>
    <p><strong>Step 2:</strong> Update your GitHub OAuth App callback URL to match your deployed server</p>
    <p><strong>Step 3:</strong> Deploy your Python OAuth proxy server to a cloud platform</p>
  </div>

  <div class="workflow-section">
    <h2>Step 1: Authenticate with GitHub</h2>
    <p>Click the button below to authenticate with GitHub using OAuth.</p>
    <button id="auth-button" class="workflow-button auth-button">Authenticate with GitHub</button>
    <button id="logout-button" class="workflow-button" style="background-color: #607D8B; display: none; margin-top: 5px;">Log Out</button>
    <div id="auth-status"></div>
  </div>
  
  <div class="workflow-section">
    <h2>Step 2: Trigger the Workflow</h2>
    <p>After authenticating, you can trigger the GitHub workflow at <a href="https://github.com/mikestiers/workflows/actions/workflows/root.yml" target="_blank">mikestiers/workflows/actions/workflows/root.yml</a></p>
    
    <button id="workflow-trigger" class="workflow-button" disabled>Trigger Workflow</button>
    <div id="workflow-status"></div>
    <div id="workflow-logs" class="workflow-logs"></div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Configuration - UPDATE THIS URL TO YOUR DEPLOYED PROXY SERVER
      const PROXY_BASE_URL = 'https://your-app-name.azurewebsites.net'; // CHANGE THIS!
      
      // GitHub repository details
      const repoOwner = 'mikestiers';
      const repoName = 'workflows';
      const workflowId = 'root.yml';
        // Authentication state
      let accessToken = '';
      let authenticationInProgress = false;
      
      // Cache DOM elements
      const authButton = document.getElementById('auth-button');
      const logoutButton = document.getElementById('logout-button');
      const authStatus = document.getElementById('auth-status');
      
      const workflowButton = document.getElementById('workflow-trigger');
      const workflowStatus = document.getElementById('workflow-status');
      const workflowLogs = document.getElementById('workflow-logs');
      
      // Initialize auth state from localStorage
      initializeAuthState();
      
      // Event listeners
      authButton.addEventListener('click', authenticateWithGitHub);
      logoutButton.addEventListener('click', logout);
      workflowButton.addEventListener('click', triggerWorkflow);
      
      function initializeAuthState() {
        const storedToken = localStorage.getItem('github_access_token');
        if (storedToken) {
          accessToken = storedToken;
          updateAuthUI(true, 'Retrieved saved authentication');
        }
      }
      
      function authenticateWithGitHub() {
        if (authenticationInProgress) {
          console.log('Authentication already in progress');
          return;
        }
        
        authenticationInProgress = true;
        updateAuthStatus('Initiating GitHub OAuth...', 'status-running');
        
        // Generate a random state parameter for CSRF protection
        const state = Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15);
        localStorage.setItem('oauth_state', state);
        
        const authUrl = `${PROXY_BASE_URL}/oauth/authorize?state=${state}`;
        
        // Open popup window for OAuth
        const popup = window.open(authUrl, 'github-oauth', 'width=600,height=700,scrollbars=yes,resizable=yes');
        
        if (!popup) {
          updateAuthStatus('Failed to open popup window. Please check popup blocker.', 'status-error');
          authenticationInProgress = false;
          return;
        }
        
        // Listen for messages from the popup
        const messageListener = (event) => {
          console.log('Received message:', event);
          
          // Verify origin matches our proxy server
          const proxyOrigin = new URL(PROXY_BASE_URL).origin;
          if (event.origin !== proxyOrigin) {
            console.log('Ignoring message from wrong origin:', event.origin);
            return;
          }
          
          if (event.data.type === 'GITHUB_OAUTH_SUCCESS') {
            console.log('OAuth success received');
            accessToken = event.data.access_token;
            localStorage.setItem('github_access_token', accessToken);
            
            popup.close();
            window.removeEventListener('message', messageListener);
            
            updateAuthUI(true, 'Successfully authenticated with GitHub!');
            authenticationInProgress = false;
          } else if (event.data.type === 'GITHUB_OAUTH_ERROR') {
            console.log('OAuth error received:', event.data.error);
            popup.close();
            window.removeEventListener('message', messageListener);
            
            updateAuthStatus(`OAuth error: ${event.data.error}`, 'status-error');
            authenticationInProgress = false;
          }
        };
        
        window.addEventListener('message', messageListener);
        
        // Check if popup was closed without completing OAuth (only after a delay)
        setTimeout(() => {
          const checkClosed = setInterval(() => {
            if (popup.closed && authenticationInProgress) {
              console.log('Popup was closed, cleaning up');
              clearInterval(checkClosed);
              window.removeEventListener('message', messageListener);
              updateAuthStatus('Authentication cancelled', 'status-warning');
              authenticationInProgress = false;
            } else if (!authenticationInProgress) {
              // Authentication completed, stop checking
              clearInterval(checkClosed);
            }
          }, 1000);
        }, 2000); // Wait 2 seconds before starting to check for closure
      }
      
      function updateAuthUI(isAuthenticated, message = '') {
        if (isAuthenticated) {
          authButton.style.display = 'none';
          logoutButton.style.display = 'block';
          workflowButton.disabled = false;
          updateAuthStatus(message || 'Authenticated with GitHub', 'status-success');
        } else {
          authButton.style.display = 'block';
          logoutButton.style.display = 'none';
          workflowButton.disabled = true;
          updateAuthStatus(message || 'Not authenticated', 'status-warning');
        }
      }
      
      function updateAuthStatus(message, statusClass) {
        authStatus.innerHTML = message;
        authStatus.className = `auth-status ${statusClass}`;
      }
      
      function logout() {
        accessToken = '';
        localStorage.removeItem('github_access_token');
        localStorage.removeItem('oauth_state');
        updateAuthUI(false, 'Logged out successfully');
        
        // Clear workflow status
        workflowStatus.innerHTML = '';
        workflowLogs.style.display = 'none';
      }
      
      async function triggerWorkflow() {
        if (!accessToken) {
          updateWorkflowStatus('Please authenticate first', 'status-error');
          return;
        }
        
        workflowButton.disabled = true;
        workflowButton.innerHTML = 'Triggering...<span class="spinner"></span>';
        
        try {
          updateWorkflowStatus('Triggering workflow...', 'status-running');
          
          const response = await fetch(`${PROXY_BASE_URL}/api/repos/${repoOwner}/${repoName}/actions/workflows/${workflowId}/dispatches`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              ref: 'main' // or your default branch
            })
          });
          
          if (response.ok) {
            updateWorkflowStatus('Workflow triggered successfully! 🎉', 'status-success');
            
            // Start polling for workflow runs
            setTimeout(() => pollWorkflowRuns(), 2000);
          } else {
            const errorText = await response.text();
            let errorMessage = `Failed to trigger workflow (${response.status})`;
            
            try {
              const errorData = JSON.parse(errorText);
              if (errorData.message) {
                errorMessage += `: ${errorData.message}`;
              }
            } catch (e) {
              errorMessage += `: ${errorText}`;
            }
            
            updateWorkflowStatus(errorMessage, 'status-error');
          }
        } catch (error) {
          console.error('Error triggering workflow:', error);
          updateWorkflowStatus(`Error: ${error.message}`, 'status-error');
        } finally {
          workflowButton.disabled = false;
          workflowButton.innerHTML = 'Trigger Workflow';
        }
      }
      
      async function pollWorkflowRuns() {
        try {
          const response = await fetch(`${PROXY_BASE_URL}/api/repos/${repoOwner}/${repoName}/actions/runs?per_page=5`, {
            headers: {
              'Authorization': `Bearer ${accessToken}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            const latestRun = data.workflow_runs && data.workflow_runs[0];
            
            if (latestRun) {
              const status = latestRun.status;
              const conclusion = latestRun.conclusion;
              
              let statusMessage = `Latest run status: ${status}`;
              let statusClass = 'status-running';
              
              if (status === 'completed') {
                statusMessage = `Workflow completed with result: ${conclusion}`;
                statusClass = conclusion === 'success' ? 'status-success' : 'status-failed';
              } else if (status === 'queued') {
                statusClass = 'status-queued';
              }
              
              statusMessage += ` (<a href="${latestRun.html_url}" target="_blank">View on GitHub</a>)`;
              
              updateWorkflowStatus(statusMessage, statusClass);
              
              // Continue polling if still running
              if (status === 'in_progress' || status === 'queued') {
                setTimeout(() => pollWorkflowRuns(), 5000);
              }
            }
          } else {
            console.error('Failed to fetch workflow runs:', response.status);
          }
        } catch (error) {
          console.error('Error polling workflow runs:', error);
        }
      }
      
      function updateWorkflowStatus(message, statusClass) {
        workflowStatus.innerHTML = message;
        workflowStatus.className = `workflow-status ${statusClass}`;
      }
    });
  </script>
</body>

</html>
