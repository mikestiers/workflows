<!DOCTYPE html>
<html>
<head>
    <title>GitHub Repository Test</title>
</head>
<body>
    <h1>GitHub Repository Access Test</h1>
    <p>This will test what repositories you have access to.</p>
    
    <button id="testRepos">Test Repository Access</button>
    <div id="results" style="margin-top: 20px; font-family: monospace; white-space: pre-wrap;"></div>
    
    <script>
        document.getElementById('testRepos').addEventListener('click', async function() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.textContent = 'Testing repository access...\n';
            
            // Get the token from localStorage (from successful OAuth)
            const token = localStorage.getItem('github_token');
            if (!token) {
                resultsDiv.textContent = 'Error: No authentication token found. Please authenticate first on the main page.';
                return;
            }
            
            try {
                // Test 1: Get user repositories
                resultsDiv.textContent += 'Fetching your repositories...\n';
                const reposResponse = await fetch('http://localhost:8000/api/user/repos', {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (reposResponse.ok) {
                    const repos = await reposResponse.json();
                    resultsDiv.textContent += `Found ${repos.length} repositories:\n`;
                    repos.slice(0, 10).forEach(repo => {
                        resultsDiv.textContent += `- ${repo.full_name} (${repo.private ? 'private' : 'public'})\n`;
                    });
                    if (repos.length > 10) {
                        resultsDiv.textContent += `... and ${repos.length - 10} more\n`;
                    }
                } else {
                    resultsDiv.textContent += `Error fetching repositories: ${reposResponse.status}\n`;
                }
                
                // Test 2: Check specific repository
                resultsDiv.textContent += '\nChecking mikestiers/workflows repository...\n';
                const repoResponse = await fetch('http://localhost:8000/api/repos/mikestiers/workflows', {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (repoResponse.ok) {
                    const repo = await repoResponse.json();
                    resultsDiv.textContent += `Repository found: ${repo.full_name}\n`;
                    resultsDiv.textContent += `Default branch: ${repo.default_branch}\n`;
                } else {
                    resultsDiv.textContent += `Repository not found or no access: ${repoResponse.status}\n`;
                }
                
                // Test 3: Check workflows in the repository
                resultsDiv.textContent += '\nChecking workflows...\n';
                const workflowsResponse = await fetch('http://localhost:8000/api/repos/mikestiers/workflows/actions/workflows', {
                    headers: { 'Authorization': `token ${token}` }
                });
                
                if (workflowsResponse.ok) {
                    const workflows = await workflowsResponse.json();
                    resultsDiv.textContent += `Found ${workflows.total_count} workflows:\n`;
                    workflows.workflows.forEach(workflow => {
                        resultsDiv.textContent += `- ${workflow.name} (${workflow.path})\n`;
                    });
                } else {
                    resultsDiv.textContent += `Error fetching workflows: ${workflowsResponse.status}\n`;
                }
                
            } catch (error) {
                resultsDiv.textContent += `Error: ${error.message}\n`;
            }
        });
    </script>
</body>
</html>
